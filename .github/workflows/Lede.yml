name: Lede

on:
  workflow_dispatch:
  
  #schedule:
    #- cron: 40 3 */3 * *

env: 
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  SCKEY: ${{ secrets.SCKEY }}
  PUSH_PLUS_TOKEN: ${{ secrets.PUSH_PLUS_TOKEN }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GIT_REPOSITORY: makebl/openwrt-package
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: Ubuntu-22.04

    name: Update ${{ matrix.target }}
    
    env:
      FOLDER_NAME: ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target: [Lede]
       
        #[Immortalwrt,Lede,Lienol,Official,Xwrt,Theme1,Theme2,adguard]
        
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install git subversion git-core wget curl grep
        sudo timedatectl set-timezone "$TZ"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        echo "FOLDER_NAME=${{ matrix.target }}" >> ${GITHUB_ENV}
        
    - name: Clone packages
      run: |
        cd $GITHUB_WORKSPACE
        sudo chmod -R +x *
        git clone -b ${{ matrix.target }} https://github.com/${{ env.GIT_REPOSITORY }} Upload
        cd Upload
        rm -Rf *
        git rm --cache *
        mkdir -p relevance
        cd relevance
        $GITHUB_WORKSPACE/${{ matrix.target }}.sh
        $GITHUB_WORKSPACE/token.sh
        
    - name: Upload
      continue-on-error: true
      run: |
        cd $GITHUB_WORKSPACE
        sudo chmod -R +x $GITHUB_WORKSPACE/Upload
        [[ -f "$GITHUB_WORKSPACE/README/LICENSE" ]] && cp $GITHUB_WORKSPACE/README/LICENSE $GITHUB_WORKSPACE/Upload/LICENSE
        [[ -f "$GITHUB_WORKSPACE/README/Lede/README.md" ]] && cp $GITHUB_WORKSPACE/README/Lede/README.md $GITHUB_WORKSPACE/Upload/README.md
        cd $GITHUB_WORKSPACE/Upload
        git add .
        git commit -m "åŒæ­¥æºç äº$(date +%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†)" || true
        git push --quiet "https://${{ secrets.REPO_TOKEN }}@github.com/${{ env.GIT_REPOSITORY }}" HEAD:${{ matrix.target }} 
        
    - name: Delete workflow runs
      continue-on-error: true
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.REPO_TOKEN }}
        repository: ${{ github.repository }}      
        retain_days: 0.5
        keep_minimum_runs: 0
        
    - name: Telegramæˆ–pushplusä¿¡æ¯é€šçŸ¥
      if: env.PUSH_PLUS_TOKEN && env.INFORMATION_NOTICE == 'PUSH' || env.TELEGRAM_BOT_TOKEN && env.INFORMATION_NOTICE == 'TG'
      run: |
        if [[ "${{ env.INFORMATION_NOTICE }}" == "TG" ]]; then
          if [[ "${{steps.compile.outcome}}" == 'success' ]]; then
            curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=æˆ‘äº²çˆ±çš„âœ¨ä¸»äººâœ¨ï¼šæ‚¨ä½¿ç”¨ã€${{matrix.target}}ã€‘æ’ä»¶åº“ã€${REPO_BRANCH}åˆ†æ”¯çš„${{env.TARGET_PROFILE}}ã€‘æ’ä»¶é¡ºåˆ©æ›´æ–°å®Œæˆäº†âœŒï¸ğŸ’¯ğŸ’(${{env.WAREHOUSE_MAN}}ä»“åº“çš„#${{env.RUN_NUMBER}}å·)ï¼($(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†))" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
          fi
        fi
        if [[ "${{ env.INFORMATION_NOTICE }}" == "PUSH" ]]; then
          if [[ "${{steps.compile.outcome}}" == 'success' ]]; then
            curl -k --data token="${{ secrets.PUSH_PLUS_TOKEN }}" --data title="[${{ env.SOURCE }}-${{ env.TARGET_PROFILE }}]æ’ä»¶æ›´æ–°æˆåŠŸ" --data "content=æˆ‘äº²çˆ±çš„âœ¨ä¸»äººâœ¨ï¼šæ‚¨ä½¿ç”¨ã€${{matrix.target}}ã€‘æ’ä»¶åº“ã€${REPO_BRANCH}åˆ†æ”¯çš„${{env.TARGET_PROFILE}}ã€‘æ’ä»¶é¡ºåˆ©æ›´æ–°å®Œæˆäº†âœŒï¸ğŸ’¯ğŸ’(${{env.WAREHOUSE_MAN}}ä»“åº“çš„#${{env.RUN_NUMBER}}å·)ï¼($(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†))" "http://www.pushplus.plus/send"
          fi
        fi
        if [[ "${{ env.INFORMATION_NOTICE }}" == "WX" ]]; then
          if [[ "${{steps.gitpush.outcome}}" == 'success' ]] && [[ "${{steps.compile.outcome}}" == 'success' ]]; then
            curl -k --data token="${{ secrets.WX_TOKEN }}" --data title="å¼€å§‹ç¼–è¯‘ã€${{ env.FOLDER_NAME }}ã€‘" --data "message=ğŸ‰ ä¸»äººğŸ’•ï¼šæ‚¨çš„ç¼–è¯‘è„šæœ¬æˆåŠŸè§¦å‘ã€${{ env.FOLDER_NAME }}ã€‘æ–‡ä»¶å¤¹ç¼–è¯‘ã€${{env.TARGET_PROFILE}}ã€‘å›ºä»¶ä¸­,è¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹(${{env.Tongzhi_Date}})" "http://${{ secrets.CURL }}/push?token=${{ secrets.WX_TOKEN }}&"
          else
            curl -k --data token="${{ secrets.WX_TOKEN }}" --data title="è§¦å‘å¯åŠ¨å¤±è´¥" --data "message=ğŸ’¥ä¸»äººâŒ ï¼šä¸Šæ¸¸æ‰©å±•é”™è¯¯æˆ–è€…è„šæœ¬é”™è¯¯,è§¦å‘å¯åŠ¨ã€${{ env.FOLDER_NAME }}ã€‘å¤±è´¥,è¯·ç‚¹å‡»è§¦å‘è„šæœ¬æ­¥éª¤æŸ¥çœ‹è¯¦æƒ…!(${{env.Tongzhi_Date}})" "http://${{ secrets.CURL }}/push?token=${{ secrets.WX_TOKEN }}&"
            exit 1
          fi
        fi     
