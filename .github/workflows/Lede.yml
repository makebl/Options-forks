name: Lede

on:
  workflow_dispatch:
  
  #schedule:
    #- cron: 40 3 */3 * *

env: 
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  SCKEY: ${{ secrets.SCKEY }}
  PUSH_PLUS_TOKEN: ${{ secrets.PUSH_PLUS_TOKEN }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  GIT_REPOSITORY: makebl/openwrt-package
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: Ubuntu-22.04

    name: Update ${{ matrix.target }}
    
    env:
      FOLDER_NAME: ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target: [Lede]
       
        #[Immortalwrt,Lede,Lienol,Official,Xwrt,Theme1,Theme2,adguard]
        
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install git subversion git-core wget curl grep
        sudo timedatectl set-timezone "$TZ"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        echo "FOLDER_NAME=${{ matrix.target }}" >> ${GITHUB_ENV}
        
    - name: Clone packages
      run: |
        cd $GITHUB_WORKSPACE
        sudo chmod -R +x *
        git clone -b ${{ matrix.target }} https://github.com/${{ env.GIT_REPOSITORY }} Upload
        cd Upload
        rm -Rf *
        git rm --cache *
        mkdir -p relevance
        cd relevance
        $GITHUB_WORKSPACE/${{ matrix.target }}.sh
        $GITHUB_WORKSPACE/token.sh
        
    - name: Upload
      continue-on-error: true
      run: |
        cd $GITHUB_WORKSPACE
        sudo chmod -R +x $GITHUB_WORKSPACE/Upload
        [[ -f "$GITHUB_WORKSPACE/README/LICENSE" ]] && cp $GITHUB_WORKSPACE/README/LICENSE $GITHUB_WORKSPACE/Upload/LICENSE
        [[ -f "$GITHUB_WORKSPACE/README/Lede/README.md" ]] && cp $GITHUB_WORKSPACE/README/Lede/README.md $GITHUB_WORKSPACE/Upload/README.md
        cd $GITHUB_WORKSPACE/Upload
        git add .
        git commit -m "同步源码于$(date +%Y年%m月%d号-%H点%M分)" || true
        git push --quiet "https://${{ secrets.REPO_TOKEN }}@github.com/${{ env.GIT_REPOSITORY }}" HEAD:${{ matrix.target }} 
        
    - name: Delete workflow runs
      continue-on-error: true
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.REPO_TOKEN }}
        repository: ${{ github.repository }}      
        retain_days: 0.5
        keep_minimum_runs: 0
        
    - name: Telegram或pushplus信息通知
      if: env.PUSH_PLUS_TOKEN && env.INFORMATION_NOTICE == 'PUSH' || env.TELEGRAM_BOT_TOKEN && env.INFORMATION_NOTICE == 'TG'
      run: |
        if [[ "${{ env.INFORMATION_NOTICE }}" == "TG" ]]; then
          if [[ "${{steps.compile.outcome}}" == 'success' ]]; then
            curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=我亲爱的✨主人✨：您使用【${{matrix.target}}】插件库【${REPO_BRANCH}分支的${{env.TARGET_PROFILE}}】插件顺利更新完成了✌️💯💐(${{env.WAREHOUSE_MAN}}仓库的#${{env.RUN_NUMBER}}号)！($(date +%Y年%m月%d号%H时%M分))" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
          fi
        fi
        if [[ "${{ env.INFORMATION_NOTICE }}" == "PUSH" ]]; then
          if [[ "${{steps.compile.outcome}}" == 'success' ]]; then
            curl -k --data token="${{ secrets.PUSH_PLUS_TOKEN }}" --data title="[${{ env.SOURCE }}-${{ env.TARGET_PROFILE }}]插件更新成功" --data "content=我亲爱的✨主人✨：您使用【${{matrix.target}}】插件库【${REPO_BRANCH}分支的${{env.TARGET_PROFILE}}】插件顺利更新完成了✌️💯💐(${{env.WAREHOUSE_MAN}}仓库的#${{env.RUN_NUMBER}}号)！($(date +%Y年%m月%d号%H时%M分))" "http://www.pushplus.plus/send"
          fi
        fi
        if [[ "${{ env.INFORMATION_NOTICE }}" == "WX" ]]; then
          if [[ "${{steps.gitpush.outcome}}" == 'success' ]] && [[ "${{steps.compile.outcome}}" == 'success' ]]; then
            curl -k --data token="${{ secrets.WX_TOKEN }}" --data title="开始编译【${{ env.FOLDER_NAME }}】" --data "message=🎉 主人💕：您的编译脚本成功触发【${{ env.FOLDER_NAME }}】文件夹编译【${{env.TARGET_PROFILE}}】固件中,请耐心等待...... 😋(${{env.Tongzhi_Date}})" "http://${{ secrets.CURL }}/push?token=${{ secrets.WX_TOKEN }}&"
          else
            curl -k --data token="${{ secrets.WX_TOKEN }}" --data title="触发启动失败" --data "message=💥主人❌ ：上游扩展错误或者脚本错误,触发启动【${{ env.FOLDER_NAME }}】失败,请点击触发脚本步骤查看详情!(${{env.Tongzhi_Date}})" "http://${{ secrets.CURL }}/push?token=${{ secrets.WX_TOKEN }}&"
            exit 1
          fi
        fi     
